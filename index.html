<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trackify</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f4f4f4;
            color: #333;
            padding: 50px;
        }
        .hidden {
            display: none;
        }
        .form-container {
            max-width: 400px;
            margin: auto;
        }
        ul {
            list-style-type: none;
            padding: 0;
        }
    </style>
</head>
<body>

    <!-- Home Page -->
    <div id="home-page">
        <h1>Welcome to Trackify</h1>
        <p>Track your favorite music from Spotify!</p>
        <button id="login-button">Log in with Spotify</button>
    </div>

    <!-- Profile Page -->
    <div id="profile-page" class="hidden">
        <h2>Welcome, <span id="display-username"></span></h2>

        <h3>Currently Playing</h3>
        <div id="current-song">
            <p>No track playing currently.</p>
        </div>

        <h3>Recent Songs</h3>
        <ul id="recent-songs">
            <li>No recent songs</li>
        </ul>

        <h3>Top Artists</h3>
        <ul id="top-artists">
            <li>No top artists yet</li>
        </ul>

        <button id="logout-button">Logout</button>
    </div>

    <script>
        // Spotify API details
        const client_id = '1af7d5d35cf74a108345de8262532178'; // Your Spotify client ID
        const redirect_uri = 'https://trackifyapp.github.io/home'; // Redirect URI

        // Function to authorize with Spotify
        const authorizeSpotify = () => {
            const scopes = 'user-read-currently-playing user-top-read user-read-recently-played user-read-private';
            const authUrl = `https://accounts.spotify.com/authorize?response_type=token&client_id=${client_id}&scope=${scopes}&redirect_uri=${redirect_uri}`;
            window.location = authUrl;
        };

        // Get access token from URL after redirect
        const getAccessToken = () => {
            const hash = window.location.hash;
            if (!hash) return null;

            const token = hash.substring(1).split('&').find(el => el.startsWith('access_token')).split('=')[1];
            localStorage.setItem('spotify_access_token', token);
            return token;
        };

        // Check if user is logged in
        const checkLogin = () => {
            const token = localStorage.getItem('spotify_access_token');
            const username = localStorage.getItem('spotify_username');
            if (token && username) {
                showProfile(username);
            } else {
                document.getElementById('home-page').classList.remove('hidden');
            }
        };

        // Handle profile page after login
        const showProfile = async (username) => {
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('profile-page').classList.remove('hidden');
            document.getElementById('display-username').textContent = username;

            const token = localStorage.getItem('spotify_access_token');
            await fetchSpotifyData(token); // Fetch data from Spotify API

            // Change URL to show profile (e.g., /home/username)
            window.history.pushState({}, '', `/home/${username}`);
        };

        // Fetch Spotify data
        const fetchSpotifyData = async (token) => {
            await fetchUserProfile(token);
            await fetchCurrentTrack(token);
            await fetchRecentSongs(token);
            await fetchTopArtists(token);
        };

        // Fetch user profile to get the display name
        const fetchUserProfile = async (token) => {
            const response = await fetch('https://api.spotify.com/v1/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            const username = data.display_name || data.id; // Use display name or fallback to user ID
            localStorage.setItem('spotify_username', username);
            document.getElementById('display-username').textContent = username;
        };

        // Fetch currently playing track
        const fetchCurrentTrack = async (token) => {
            const response = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            const currentSongElement = document.getElementById('current-song');
            if (data && data.item) {
                const track = data.item;
                currentSongElement.innerHTML = `<p>${track.name} by ${track.artists.map(artist => artist.name).join(', ')}</p>`;
            } else {
                currentSongElement.innerHTML = '<p>No track playing currently.</p>';
            }
        };

        // Fetch recent songs
        const fetchRecentSongs = async (token) => {
            const response = await fetch('https://api.spotify.com/v1/me/player/recently-played?limit=5', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            const recentSongsElement = document.getElementById('recent-songs');
            recentSongsElement.innerHTML = '';
            data.items.forEach(track => {
                recentSongsElement.innerHTML += `<li>${track.track.name} by ${track.track.artists.map(artist => artist.name).join(', ')}</li>`;
            });
        };

        // Fetch top artists
        const fetchTopArtists = async (token) => {
            const response = await fetch('https://api.spotify.com/v1/me/top/artists?limit=5', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            const topArtistsElement = document.getElementById('top-artists');
            topArtistsElement.innerHTML = '';
            data.items.forEach(artist => {
                topArtistsElement.innerHTML += `<li>${artist.name}</li>`;
            });
        };

        // Event listener for login button
        document.getElementById('login-button').addEventListener('click', () => {
            authorizeSpotify();
        });

        // Event listener for logout button
        document.getElementById('logout-button').addEventListener('click', () => {
            localStorage.removeItem('spotify_access_token');
            localStorage.removeItem('spotify_username');
            window.location.href = '/';
        });

        // Handle page load
        window.onload = async () => {
            const token = getAccessToken();
            if (token) {
                const username = localStorage.getItem('spotify_username');
                await fetchSpotifyData(token);
                showProfile(username);
            } else {
                checkLogin();
            }
        };

        // Handle browser back/forward buttons
        window.onpopstate = () => {
            checkLogin();
        };
    </script>
</body>
</html>